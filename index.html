<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Christopher Kumar - Portfolio</title>
    <link rel="stylesheet" href="styles.css" />
    <!-- Load API config for local development (create this file locally, don't commit) -->
    <script>
      // This prevents errors if config.js doesn't exist
      window.CONFIG = window.CONFIG || {};
    </script>
    <script
      src="config.js"
      onerror="console.log('config.js not found - using defaults')"
    ></script>
    <style>
      /* Chat Button Styles */
      .chat-button {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, #0071e3, #0077ed);
        border-radius: 50%;
        border: none;
        cursor: pointer;
        box-shadow: 0 4px 20px rgba(0, 113, 227, 0.3);
        z-index: 1000;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .chat-button:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 30px rgba(0, 113, 227, 0.4);
      }

      .chat-button svg {
        width: 28px;
        height: 28px;
        fill: white;
      }

      /* Chat Window Styles */
      .chat-window {
        position: fixed;
        bottom: 100px;
        right: 20px;
        width: 380px;
        height: 500px;
        background: rgba(255, 255, 255, 0.98);
        backdrop-filter: blur(20px);
        border-radius: 20px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        display: none;
        flex-direction: column;
        z-index: 1001;
        border: 1px solid rgba(0, 0, 0, 0.08);
        overflow: hidden;
        animation: slideUp 0.3s ease;
      }

      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .chat-window.active {
        display: flex;
      }

      .chat-header {
        background: linear-gradient(135deg, #0071e3, #0077ed);
        color: white;
        padding: 1.2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .chat-header h3 {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 600;
      }

      .chat-close {
        background: none;
        border: none;
        color: white;
        cursor: pointer;
        padding: 5px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        transition: background 0.2s ease;
      }

      .chat-close:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .message {
        max-width: 80%;
        word-wrap: break-word;
        animation: fadeIn 0.3s ease;
      }

      .message.user {
        align-self: flex-end;
        background: #0071e3;
        color: white;
        padding: 0.8rem 1.2rem;
        border-radius: 18px 18px 4px 18px;
      }

      .message.assistant {
        align-self: flex-start;
        background: #f5f5f7;
        color: #1d1d1f;
        padding: 0.8rem 1.2rem;
        border-radius: 18px 18px 18px 4px;
        border: 1px solid rgba(0, 0, 0, 0.06);
      }

      .message.system {
        align-self: center;
        color: #86868b;
        font-size: 0.85rem;
        text-align: center;
        font-style: italic;
      }

      .chat-input-container {
        padding: 1rem;
        border-top: 1px solid rgba(0, 0, 0, 0.08);
        display: flex;
        gap: 0.5rem;
      }

      .chat-input {
        flex: 1;
        padding: 0.8rem 1rem;
        border: 1px solid rgba(0, 0, 0, 0.15);
        border-radius: 20px;
        font-size: 0.9rem;
        outline: none;
        transition: border-color 0.2s ease;
        font-family: inherit;
      }

      .chat-input:focus {
        border-color: #0071e3;
      }

      .chat-send {
        background: #0071e3;
        border: none;
        color: white;
        padding: 0.8rem;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
      }

      .chat-send:hover {
        background: #0051a2;
        transform: scale(1.05);
      }

      .chat-send:disabled {
        background: #86868b;
        cursor: not-allowed;
        transform: scale(1);
      }

      .typing-indicator {
        display: inline-flex;
        gap: 4px;
        padding: 0.8rem 1.2rem;
        background: #f5f5f7;
        border-radius: 18px;
        align-self: flex-start;
        border: 1px solid rgba(0, 0, 0, 0.06);
      }

      .typing-indicator span {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #86868b;
        animation: typing 1.4s infinite;
      }

      .typing-indicator span:nth-child(2) {
        animation-delay: 0.2s;
      }

      .typing-indicator span:nth-child(3) {
        animation-delay: 0.4s;
      }

      @keyframes typing {
        0%,
        60%,
        100% {
          transform: translateY(0);
          opacity: 0.5;
        }
        30% {
          transform: translateY(-10px);
          opacity: 1;
        }
      }

      /* Responsive Design */
      @media (max-width: 768px) {
        .chat-window {
          width: calc(100% - 20px);
          right: 10px;
          left: 10px;
          bottom: 80px;
          height: 70vh;
          max-height: 500px;
        }

        .chat-button {
          bottom: 80px;
          right: 15px;
          width: 56px;
          height: 56px;
        }
      }

      /* Error message styles */
      .message.error {
        align-self: center;
        background: rgba(255, 59, 48, 0.1);
        color: #ff3b30;
        padding: 0.8rem 1.2rem;
        border-radius: 12px;
        border: 1px solid rgba(255, 59, 48, 0.2);
        font-size: 0.85rem;
      }

      /* Loading animation */
      .loading-message {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: #86868b;
        font-size: 0.85rem;
        font-style: italic;
      }
    </style>
  </head>
  <body>
    <div class="gradient-bg"></div>

    <header>
      <h1>Christopher Kumar</h1>
      <p class="subtitle">Computer Systems Engineer & Researcher</p>
      <p class="about-me">
        I've worked on projects that use coding, AI, and computer vision to
        solve real problems. I've built tools with Python, TensorFlow, and
        PyTorch, and enjoy making things that are both practical and grounded in
        research.
      </p>
      <div class="header-contact-links">
        <a href="mailto:your.email@example.com" class="header-contact-link">
          <svg
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path
              d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"
            ></path>
            <polyline points="22,6 12,13 2,6"></polyline>
          </svg>
          Email
        </a>
        <a
          href="https://linkedin.com/in/yourprofile"
          target="_blank"
          class="header-contact-link"
        >
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
            <path
              d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"
            />
          </svg>
          LinkedIn
        </a>
        <a
          href="https://github.com/christopherkumar"
          target="_blank"
          class="header-contact-link"
        >
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
            <path
              d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"
            />
          </svg>
          GitHub
        </a>
        <a
          href="https://drive.google.com/file/d/1dS-SfApwipPBnU6ICy0jSEu1XnfnVF2f/view"
          target="_blank"
          class="header-contact-link resume-link"
        >
          <svg
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path
              d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"
            ></path>
            <polyline points="14 2 14 8 20 8"></polyline>
            <line x1="16" y1="13" x2="8" y2="13"></line>
            <line x1="16" y1="17" x2="8" y2="17"></line>
            <line x1="9" y1="10" x2="9" y2="10"></line>
          </svg>
          Resume
        </a>
      </div>
    </header>

    <div id="coding-projects" class="tab-content">
      <div class="projects-container" id="coding-projects-container">
        <!-- Coding projects will be dynamically inserted here -->
      </div>
    </div>

    <div id="research-projects" class="tab-content">
      <div class="projects-container" id="research-projects-container">
        <!-- Research projects will be dynamically inserted here -->
      </div>
    </div>

    <div id="work-experience" class="tab-content active">
      <div class="experience-container" id="work-experience-container">
        <!-- Work experience will be dynamically inserted here -->
      </div>
    </div>

    <div id="education" class="tab-content">
      <div class="education-container" id="education-container">
        <!-- Education entries will be dynamically inserted here -->
      </div>
    </div>

    <!-- Footer -->
    <footer>
      <div class="footer-content">
        <p class="footer-note">
          © 2025 Christopher Kumar. Built with vanilla JS.
        </p>
      </div>
    </footer>

    <!-- Tab Navigation -->
    <div class="tab-container">
      <div class="tab-nav">
        <div class="tab-indicator" id="tabIndicator"></div>
        <button
          class="tab-button active"
          onclick="switchTab('work-experience', this)"
        >
          Experience
        </button>
        <button class="tab-button" onclick="switchTab('education', this)">
          Education
        </button>
        <button class="tab-button" onclick="switchTab('coding-projects', this)">
          Coding
        </button>
        <button
          class="tab-button"
          onclick="switchTab('research-projects', this)"
        >
          Research
        </button>
      </div>
    </div>

    <!-- Chat Button -->
    <button class="chat-button" id="chatButton" onclick="toggleChat()">
      <svg viewBox="0 0 24 24">
        <path
          d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"
        />
      </svg>
    </button>

    <!-- Chat Window -->
    <div class="chat-window" id="chatWindow">
      <div class="chat-header">
        <h3>Ask about Christopher</h3>
        <button class="chat-close" onclick="toggleChat()">
          <svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="chat-messages" id="chatMessages">
        <div class="message system">
          Hi! Ask me anything about Christopher's projects, experience, or
          skills! Try questions like "where did he study?" or "what has he
          built?"
        </div>
      </div>
      <div class="chat-input-container">
        <input
          type="text"
          class="chat-input"
          id="chatInput"
          placeholder="Ask a question..."
          onkeypress="handleKeyPress(event)"
        />
        <button class="chat-send" id="sendButton" onclick="sendMessage()">
          <svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <line x1="22" y1="2" x2="11" y2="13"></line>
            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
          </svg>
        </button>
      </div>
    </div>

    <script src="projects-data.js"></script>
    <script src="script.js"></script>
    <script>
      // API Configuration
      // For local development: Create a config.js file with your API key
      // For production: Use environment variables through Netlify Functions
      const GEMINI_API_KEY =
        typeof CONFIG !== "undefined"
          ? CONFIG.GEMINI_API_KEY
          : "YOUR_API_KEY_HERE";
      const GEMINI_API_URL =
        typeof CONFIG !== "undefined"
          ? CONFIG.GEMINI_API_URL
          : "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent";

      // Chat functionality
      let chatOpen = false;
      let messageHistory = [];
      let isProcessing = false;

      // Rate limiting
      let messageCount = 0;
      let lastResetTime = Date.now();
      const RATE_LIMIT = 10; // messages per minute
      const RATE_WINDOW = 60000; // 1 minute

      // Build context from portfolio data
      function buildPortfolioContext() {
        const context = {
          name: "Christopher Kumar",
          title: "Computer Systems Engineer & Researcher",
          about:
            "I've worked on projects that use coding, AI, and computer vision to solve real problems. I've built tools with Python, TensorFlow, and PyTorch, and enjoy making things that are both practical and grounded in research.",
          codingProjects: codingProjects.map((p) => ({
            title: p.title,
            description: p.description,
            technologies: p.technologies.join(", "),
          })),
          researchProjects: researchProjects.map((p) => ({
            title: p.title,
            description: p.description,
            technologies: p.technologies.join(", "),
          })),
          workExperience: workExperience.map((w) => ({
            title: w.title,
            company: w.company,
            duration: w.duration,
            description: w.description,
            technologies: w.technologies.join(", "),
          })),
          education: education.map((e) => ({
            degree: e.degree,
            institution: e.institution,
            duration: e.duration,
            description: e.description,
            highlights: e.highlights.join("; "),
          })),
        };
        return JSON.stringify(context, null, 2);
      }

      function toggleChat() {
        chatOpen = !chatOpen;
        const chatWindow = document.getElementById("chatWindow");
        const chatButton = document.getElementById("chatButton");

        if (chatOpen) {
          chatWindow.classList.add("active");
          chatButton.style.transform = "scale(0.9)";
          document.getElementById("chatInput").focus();

          // Check API status on first open
          if (
            messageHistory.length === 0 &&
            (GEMINI_API_KEY === "YOUR_API_KEY_HERE" || !GEMINI_API_KEY)
          ) {
            console.log(
              "Chat opened - Using enhanced fallback system (API not configured)"
            );
          }
        } else {
          chatWindow.classList.remove("active");
          chatButton.style.transform = "scale(1)";
        }
      }

      function handleKeyPress(event) {
        if (event.key === "Enter" && !event.shiftKey) {
          sendMessage();
        }
      }

      function addMessage(content, type) {
        const messagesContainer = document.getElementById("chatMessages");
        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${type}`;
        messageDiv.textContent = content;
        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        return messageDiv;
      }

      function showTypingIndicator() {
        const messagesContainer = document.getElementById("chatMessages");
        const typingDiv = document.createElement("div");
        typingDiv.className = "typing-indicator";
        typingDiv.id = "typingIndicator";
        typingDiv.innerHTML = "<span></span><span></span><span></span>";
        messagesContainer.appendChild(typingDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }

      function removeTypingIndicator() {
        const indicator = document.getElementById("typingIndicator");
        if (indicator) {
          indicator.remove();
        }
      }

      function checkRateLimit() {
        const now = Date.now();
        if (now - lastResetTime > RATE_WINDOW) {
          messageCount = 0;
          lastResetTime = now;
        }

        if (messageCount >= RATE_LIMIT) {
          return false;
        }

        messageCount++;
        return true;
      }

      function isQuestionRelevant(question) {
        // Basic relevance check
        const inappropriatePatterns = [
          /\b(hack|exploit|vulnerability|injection|malicious)\b/i,
          /\b(personal|private|phone|address|social\s*security)\b/i,
          /\b(password|secret|token|api\s*key)\b/i,
        ];

        return !inappropriatePatterns.some((pattern) => pattern.test(question));
      }

      async function sendMessage() {
        const input = document.getElementById("chatInput");
        const sendButton = document.getElementById("sendButton");
        const message = input.value.trim();

        if (!message || isProcessing) return;

        // Check rate limit
        if (!checkRateLimit()) {
          addMessage(
            "Please slow down! You've reached the message limit. Try again in a minute.",
            "error"
          );
          return;
        }

        // Check relevance
        if (!isQuestionRelevant(message)) {
          addMessage(
            "Please ask questions related to Christopher's portfolio, projects, or professional experience.",
            "system"
          );
          input.value = "";
          return;
        }

        // Add user message
        addMessage(message, "user");
        input.value = "";

        // Disable input during processing
        isProcessing = true;
        input.disabled = true;
        sendButton.disabled = true;

        // Show typing indicator
        showTypingIndicator();

        try {
          // Prepare conversation history for Gemini
          const conversationHistory = messageHistory.map((msg, i) => ({
            role: i % 2 === 0 ? "user" : "model",
            parts: [{ text: msg }],
          }));

          let response;

          // Check if we're in production (Netlify) or development
          if (
            window.location.hostname === "localhost" ||
            window.location.hostname === "127.0.0.1"
          ) {
            // Development: Direct API call (requires API key in code)
            console.log("Using development mode - direct API call");
            console.log(
              "API Key configured:",
              GEMINI_API_KEY !== "YOUR_API_KEY_HERE" && GEMINI_API_KEY
                ? "Yes"
                : "No"
            );

            if (GEMINI_API_KEY === "YOUR_API_KEY_HERE" || !GEMINI_API_KEY) {
              throw new Error(
                "API key not configured. Please create a config.js file with your Gemini API key."
              );
            }

            const apiUrl = `${GEMINI_API_URL}?key=${GEMINI_API_KEY}`;
            console.log("Making API request to Gemini...");

            response = await fetch(apiUrl, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                contents: [
                  {
                    role: "user",
                    parts: [
                      {
                        text: `You are an AI assistant for Christopher Kumar's portfolio website. 
                      You should ONLY answer questions about Christopher's professional background, projects, skills, and experience.
                      Be helpful, concise, and professional. If asked about topics unrelated to Christopher's portfolio, 
                      politely redirect the conversation back to his professional work.
                      
                      Here is Christopher's portfolio information:
                      ${buildPortfolioContext()}
                      
                      Important guidelines:
                      - Only discuss information provided in the portfolio context
                      - Don't make up or assume information not in the context
                      - Keep responses concise (2-3 sentences max)
                      - Be professional and helpful
                      - If asked about contact information, refer to the links in the header
                      - Don't engage with inappropriate or off-topic questions`,
                      },
                    ],
                  },
                  ...conversationHistory,
                  {
                    role: "user",
                    parts: [{ text: message }],
                  },
                ],
                generationConfig: {
                  temperature: 0.7,
                  topK: 1,
                  topP: 1,
                  maxOutputTokens: 200,
                },
                safetySettings: [
                  {
                    category: "HARM_CATEGORY_HARASSMENT",
                    threshold: "BLOCK_MEDIUM_AND_ABOVE",
                  },
                  {
                    category: "HARM_CATEGORY_HATE_SPEECH",
                    threshold: "BLOCK_MEDIUM_AND_ABOVE",
                  },
                  {
                    category: "HARM_CATEGORY_SEXUALLY_EXPLICIT",
                    threshold: "BLOCK_MEDIUM_AND_ABOVE",
                  },
                  {
                    category: "HARM_CATEGORY_DANGEROUS_CONTENT",
                    threshold: "BLOCK_MEDIUM_AND_ABOVE",
                  },
                ],
              }),
            });

            console.log("API Response status:", response.status);
          } else {
            // Production: Use Netlify function
            console.log("Using production mode - Netlify function");
            response = await fetch("/.netlify/functions/chat", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                message,
                conversationHistory,
                portfolioContext: buildPortfolioContext(),
              }),
            });
          }

          if (!response.ok) {
            const errorText = await response.text();
            console.error("API Error Response:", errorText);
            throw new Error(
              `API request failed: ${response.status} - ${errorText}`
            );
          }

          const data = await response.json();
          console.log("API Response data:", data);

          let aiResponse;
          if (data.response) {
            // Response from Netlify function
            aiResponse = data.response;
          } else if (data.candidates?.[0]?.content?.parts?.[0]?.text) {
            // Direct Gemini API response
            aiResponse = data.candidates[0].content.parts[0].text;
          } else {
            console.error("Invalid API response structure:", data);
            throw new Error("Invalid API response");
          }

          // Remove typing indicator
          removeTypingIndicator();

          // Add AI response
          addMessage(aiResponse, "assistant");

          // Update message history
          messageHistory.push(message);
          messageHistory.push(aiResponse);

          // Keep history limited
          if (messageHistory.length > 10) {
            messageHistory = messageHistory.slice(-10);
          }
        } catch (error) {
          console.error("Chat error:", error);
          removeTypingIndicator();

          // Check if this is an API configuration issue
          if (
            GEMINI_API_KEY === "YOUR_API_KEY_HERE" ||
            !GEMINI_API_KEY ||
            error.message.includes("API key not configured")
          ) {
            // Don't show error message every time - just use the fallback silently
            console.log("Using fallback responses - API not configured");
          } else {
            // Only show error for actual API failures
            console.error("API Error details:", error.message);
          }

          // Always provide intelligent fallback responses
          const fallbackResponse = getFallbackResponse(message);
          addMessage(fallbackResponse, "assistant");
        } finally {
          // Re-enable input
          isProcessing = false;
          input.disabled = false;
          sendButton.disabled = false;
          input.focus();
        }
      }

      // Helper function for fuzzy string matching
      function calculateSimilarity(str1, str2) {
        const longer = str1.length > str2.length ? str1 : str2;
        const shorter = str1.length > str2.length ? str2 : str1;

        if (longer.length === 0) return 1.0;

        const editDistance = (function () {
          const matrix = [];
          for (let i = 0; i <= shorter.length; i++) {
            matrix[i] = [i];
          }
          for (let j = 0; j <= longer.length; j++) {
            matrix[0][j] = j;
          }
          for (let i = 1; i <= shorter.length; i++) {
            for (let j = 1; j <= longer.length; j++) {
              if (shorter.charAt(i - 1) === longer.charAt(j - 1)) {
                matrix[i][j] = matrix[i - 1][j - 1];
              } else {
                matrix[i][j] = Math.min(
                  matrix[i - 1][j - 1] + 1,
                  matrix[i][j - 1] + 1,
                  matrix[i - 1][j] + 1
                );
              }
            }
          }
          return matrix[shorter.length][longer.length];
        })();

        return (longer.length - editDistance) / longer.length;
      }

      // Improved intent detection
      function detectIntent(message) {
        const lowerMessage = message.toLowerCase();

        // Define intents with various phrasings
        const intents = {
          education: {
            keywords: [
              "education",
              "study",
              "studied",
              "university",
              "uni",
              "degree",
              "school",
              "graduate",
              "bachelor",
              "learn",
              "where",
              "usq",
              "qualification",
            ],
            phrases: [
              "where did",
              "where study",
              "what uni",
              "which university",
              "what school",
              "educational background",
            ],
            typos: [
              "educatioon",
              "eduction",
              "studay",
              "univeristy",
              "bachelors",
            ],
          },
          projects: {
            keywords: [
              "project",
              "built",
              "created",
              "developed",
              "made",
              "coding",
              "github",
              "work on",
              "portfolio",
            ],
            phrases: [
              "what has",
              "what did",
              "show me",
              "tell me about projects",
            ],
            typos: ["proejct", "projets", "prject"],
          },
          experience: {
            keywords: [
              "experience",
              "work",
              "job",
              "intern",
              "company",
              "worked",
              "position",
              "role",
              "employment",
              "career",
            ],
            phrases: [
              "work experience",
              "where work",
              "current job",
              "previous jobs",
            ],
            typos: ["experiance", "experince", "wrk", "internshp"],
          },
          skills: {
            keywords: [
              "skill",
              "technology",
              "language",
              "programming",
              "tech",
              "stack",
              "tool",
              "framework",
              "know",
              "can",
            ],
            phrases: [
              "what languages",
              "tech stack",
              "programming languages",
              "what skills",
            ],
            typos: ["skils", "technolgy", "programing", "langauge"],
          },
          research: {
            keywords: [
              "research",
              "paper",
              "study",
              "publication",
              "academic",
              "thesis",
              "honours",
            ],
            phrases: ["research papers", "published work", "academic work"],
            typos: ["reserch", "reaserch", "publcation"],
          },
          contact: {
            keywords: [
              "contact",
              "email",
              "reach",
              "connect",
              "linkedin",
              "github",
              "resume",
              "cv",
              "hire",
              "message",
              "get in touch",
            ],
            phrases: [
              "how to contact",
              "reach out",
              "get in touch",
              "contact info",
            ],
            typos: ["contct", "emial", "linkdin", "resum"],
          },
          current: {
            keywords: [
              "current",
              "now",
              "today",
              "present",
              "doing",
              "latest",
              "recent",
            ],
            phrases: ["what doing now", "current role", "working on"],
            typos: ["curent", "currnt", "presnt"],
          },
        };

        // Check for exact matches first
        for (const [intentName, intentData] of Object.entries(intents)) {
          // Check keywords
          for (const keyword of intentData.keywords) {
            if (lowerMessage.includes(keyword)) {
              return intentName;
            }
          }

          // Check phrases
          for (const phrase of intentData.phrases) {
            if (lowerMessage.includes(phrase)) {
              return intentName;
            }
          }

          // Check common typos
          if (intentData.typos) {
            for (const typo of intentData.typos) {
              if (lowerMessage.includes(typo)) {
                return intentName;
              }
            }
          }
        }

        // Fuzzy matching for words in the message
        const words = lowerMessage.split(/\s+/);
        for (const word of words) {
          for (const [intentName, intentData] of Object.entries(intents)) {
            for (const keyword of intentData.keywords) {
              if (calculateSimilarity(word, keyword) > 0.8) {
                return intentName;
              }
            }
          }
        }

        // Check for question patterns
        if (lowerMessage.match(/^(where|what|when|who|how|which)\s/)) {
          if (
            lowerMessage.includes("chris") ||
            lowerMessage.includes("he") ||
            lowerMessage.includes("christopher")
          ) {
            // "where did chris study" -> education
            if (
              lowerMessage.match(
                /\b(study|studied|learn|go|attend|graduate|education|uni|university)\b/
              )
            )
              return "education";
            // "what does chris do" -> current
            if (lowerMessage.match(/\b(do|doing|work|working|job|role)\b/))
              return "current";
            // "what did chris build" -> projects
            if (
              lowerMessage.match(
                /\b(build|built|make|made|create|created|develop|developed|project)\b/
              )
            )
              return "projects";
            // "where does chris work" -> experience
            if (
              lowerMessage.match(/\b(work|worked|experience|intern|company)\b/)
            )
              return "experience";
          }
        }

        // Handle very short queries about education
        if (
          message.length < 30 &&
          lowerMessage.match(
            /\b(where|which|what)\b.*\b(study|studied|uni|university|school)\b/
          )
        ) {
          return "education";
        }

        return "general";
      }

      function getFallbackResponse(message) {
        const intent = detectIntent(message);
        console.log("Detected intent:", intent, "for message:", message);

        const responses = {
          education:
            "Christopher studied at the University of Southern Queensland (USQ), earning a Bachelor of Engineering (Honours) in Computer Systems from 2019-2023. He focused on machine learning, computer vision, and embedded systems. Before that, he completed a Foundation Science Programme at The University of the South Pacific in 2018, and graduated from Mahatma Gandhi Memorial High School in Fiji in 2017.",

          projects:
            "Christopher has built several impressive projects:\n• Audio Transforms - a DSP toolkit for real-time audio processing\n• CV Terminal Website - an interactive command-line portfolio\n• Simple Ollama Chatbot - for local LLM testing\n• Research on camera hardware's impact on ML classification\n• LLM automated grading systems\nEach showcases his skills in different areas from audio processing to AI. Which interests you most?",

          experience:
            "Christopher is currently a Software Engineering Intern at Aubot (March 2025-present), stress-testing coding exercises. Previously, he was an AI/LLM Engineering Intern at USQ, working on automated grading with Large Language Models. He also has experience as a Data Annotator for computer vision projects and worked as a youth leader at Vinnies SENSE. His diverse experience spans AI, education, and community service.",

          skills:
            "Christopher has a diverse technical skillset including:\n• Languages: Python, JavaScript, HTML/CSS\n• ML/AI: TensorFlow, PyTorch, OpenAI, Ollama, HuggingFace\n• Specialties: Computer Vision (OpenCV), DSP, RAG systems, Prompt Engineering\n• Tools: Git, Linux, Embedded Systems\nHe combines strong programming skills with deep knowledge of AI and machine learning.",

          research:
            "Christopher has authored three research papers:\n1. 'Camera Hardware Impact on ML Classification' - examining how different cameras affect ML model accuracy\n2. 'LLM Automated Grading Performance Study' - comparing LLM effectiveness across assessment types\n3. 'Applied RAG Framework Evaluation' - developing benchmarks for Retrieval-Augmented Generation systems\nAll papers demonstrate his ability to conduct rigorous research with practical applications.",

          contact:
            "You can connect with Christopher through:\n• Email - via the link in the header\n• LinkedIn - professional networking\n• GitHub - github.com/christopherkumar\n• Resume - available for download in the header\nHe's based in Brisbane, Queensland, Australia and open to opportunities in AI, software engineering, and research.",

          current:
            "Christopher is currently working as a Software Engineering Intern at Aubot (since March 2025), where he ensures the quality of their coding education platform. He continues to work on personal projects involving AI, computer vision, and web development. He's particularly interested in the intersection of AI and education, as shown by his research and internship experiences.",

          general:
            "I'm here to help you learn about Christopher Kumar! I can tell you about his:\n• Education at USQ (Computer Systems Engineering)\n• Work experience (current role at Aubot)\n• Technical projects (Audio Transforms, AI chatbots)\n• Research papers (ML, LLMs, RAG systems)\n• Skills (Python, JavaScript, ML/AI)\n• How to contact him\nWhat interests you most?",
        };

        return responses[intent] || responses.general;
      }

      // Close chat on escape key
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && chatOpen) {
          toggleChat();
        }
      });

      // Adjust chat window position on mobile when keyboard appears
      if (window.visualViewport) {
        window.visualViewport.addEventListener("resize", () => {
          const chatWindow = document.getElementById("chatWindow");
          if (
            chatOpen &&
            window.visualViewport.height < window.innerHeight * 0.75
          ) {
            chatWindow.style.bottom = "10px";
          } else {
            chatWindow.style.bottom = "";
          }
        });
      }
    </script>
  </body>
</html>
